// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: cyan; icon-glyph: tasks;
// Build at 2023-01-26T11:23:55.985Z
"use strict";var e=function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},e.apply(this,arguments)};function t(e,t,n,r){return new(n||(n=Promise))((function(a,s){function i(e){try{c(r.next(e))}catch(e){s(e)}}function o(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,o)}c((r=r.apply(e,t||[])).next())}))}function n(e,t){var n,r,a,s,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(i=0)),i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}function r(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var a,s,i,o,c=function(){function e(e){this.base="https://api.notion.com/v1",this.secret=e}return e.prototype.request=function(e,t,n){this.base.endsWith("/")||(this.base+="/"),t.startsWith("/")&&(t=t.slice(1));var r=new Request(t.includes("://")?t:"".concat(this.base).concat(t));return r.method=e.toUpperCase(),r.body=n?JSON.stringify(n):null,r.url.startsWith(this.base)&&(r.headers={Authorization:"Bearer ".concat(this.secret),"Notion-Version":"2022-06-28","Content-Type":"application/json"}),r},e.prototype.get=function(e){return this.request("GET",e).loadJSON()},e.prototype.post=function(e,t){return this.request("POST",e,t).loadJSON()},e.prototype.queryDatabase=function(e,t){return this.post("databases/".concat(e,"/query"),t)},e.prototype.getDatabase=function(e){return this.get("databases/".concat(e))},e.prototype.getPage=function(e){return this.get("pages/".concat(e))},e.prototype.getImage=function(e){return this.request("GET",e).loadImage()},e}(),l=function(){function e(e){if(e&&e.constructor&&e.constructor.toString){var t=e.constructor.toString().match(/function\s*(\w+)/);if(t&&2==t.length)return t[1]}}function r(t,n){return Object.keys(n).forEach((function(r){if(-1!==r.indexOf("*")){if(!((r=r.replace("*",""))in t))throw new Error('Method "'.concat(r,'()" is not applicable to instance of ').concat(e(t)));Array.isArray(n["*"+r])?t[r].apply(t,n["*"+r]):t[r](n[r])}else{if(!(r in t))throw new Error('Property "'.concat(r,'" is not applicable to instance of ').concat(e(t)));t[r]=n[r]}})),t}function a(e,t){return t.forEach((function(t){if("text"===t.tag){var n=/(\$\$\[.+\])/gi;n.test(t.textContent)&&(t.textContent=t.textContent.replace(n,(function(e,t){return i[t].toString()})));var o=e.addText(t.textContent.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&"));r(o,s(t.attributes,"styles")),r(o,s(t.attributes,"attr"))}else if("spacer"===t.tag){var c=parseInt(s(t.attributes,"value"),10);c<1||isNaN(c)?e.addSpacer():e.addSpacer(c)}else if("image"===t.tag){var l=e.addImage(s(t.attributes,"src"));r(l,s(t.attributes,"styles")),r(l,s(t.attributes,"attr"))}else if("date"===t.tag){var u=e.addDate(s(t.attributes,"value"));r(u,s(t.attributes,"styles")),r(u,s(t.attributes,"attr"))}else if("stack"===t.tag){r(d=e.addStack(),s(t.attributes,"styles")),r(d,s(t.attributes,"attr")),a(d,t.children)}else if(-1!==["hstack","vstack"].indexOf(t.tag)){var d;(d=e.addStack())["hstack"===t.tag?"layoutHorizontally":"layoutVertically"](),r(d,s(t.attributes,"styles")),r(d,s(t.attributes,"attr")),a(d,t.children)}})),e}function s(e,t){void 0===e&&(e=[]),void 0===t&&(t="styles");var n={};return e.forEach((function(e){e.name.toLowerCase()===t.toLowerCase()&&(n=void 0!==i[e.value]?i[e.value]:e.value)})),n}var i={};function o(e,t){var n="";return e.forEach((function(e,r){if(t[r])if(Array.isArray(t[r])&&(t[r]=t[r].join("")),"string"==typeof t[r])n+=e+t[r];else{var a="$$["+UUID.string()+Math.floor(20*Math.random())+"]";i[a]=t[r],n+=e+a}else n+=e})),n}function c(e){return t(this,void 0,void 0,(function(){var t,r,a,s;return n(this,(function(n){switch(n.label){case 0:return[4,(t=new WebView).loadHTML("<html></html>")];case 1:return n.sent(),e=function(e){return(e=e.replace(/(\r\n|\n|\r)/gm,"")).replace(/<\s*text[^>]*>(.*?)<\s*\/\s*text>/gi,(function(e,t){return e.replace(t,t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"))}))}(e),e="<tabom>".concat(e,"</tabom>"),r="\n        var getAttributes = function (attributes) {\n            return Array.prototype.map.call(attributes, function (attribute) {\n                return {\n                    name: attribute.name,\n                    value: attribute.value\n                };\n            });\n        };\n        \n        var createDOMMap = function (element) {\n            return Array.prototype.map.call(element.childNodes, (function (node) {\n                if (node.nodeType !== 3 && node.nodeType !== 8) {\n                    var details = {\n                        tag: node.tagName.toLowerCase(),\n                        textContent: node.textContent,\n                        attributes: node.nodeType !== 1 ? [] : getAttributes(node.attributes)\n                    };\n                    details.children = createDOMMap(node);\n                    return details;\n                }\n                return null;\n            })).filter((e) => e !== null);\n        };\n        \n        function getDom() {\n            let htmlStr = '".concat(e,"';\n            const dom = new DOMParser();\n            let doc = dom.parseFromString(htmlStr, 'application/xml');\n            return JSON.stringify(createDOMMap(doc.documentElement));\n        }\n        try {\n            completion(getDom());\n        }\n        catch (err) {\n            completion([{\n                tag: 'error',\n                textContent: err.message\n            }]);\n        }    \n      "),[4,t.evaluateJavaScript(r,!0)];case 2:if(a=n.sent(),(s=JSON.parse(a)).length&&-1!==s[0].tag.toLocaleLowerCase().indexOf("error"))throw new Error(s[0].textContent);return[2,s]}}))}))}return{widgetMarkup:function(e){for(var i=[],l=1;l<arguments.length;l++)i[l-1]=arguments[l];return t(this,void 0,void 0,(function(){var t,l,u,d;return n(this,(function(n){switch(n.label){case 0:return[4,c(o(e,i))];case 1:if(t=n.sent(),void 0===(l=t[0]))throw new Error("WidgetMarkup requires that the <widget> element be the parent element of your widget.");return u=l.children,r(d=new ListWidget,s(l.attributes,"styles")),r(d,s(l.attributes,"attr")),a(d,u),[2,d]}}))}))},concatMarkup:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=o(e,t);return r}}}(),u=l.widgetMarkup,d=l.concatMarkup,p="fr.zaosoula.notionwidget",h=function(){return Keychain.contains(p)?JSON.parse(Keychain.get(p)):{notionSecret:"",databaseId:"",sorts:[],filter:{}}},f=h();function g(){return t(this,void 0,void 0,(function(){var e,t;return n(this,(function(n){switch(n.label){case 0:return[4,y()];case 1:return n.sent(),e=new Alert,args.queryParameters.settings?[4,m()]:[3,3];case 2:n.sent(),n.label=3;case 3:return e.title=Script.name(),e.addAction("Preview the widget"),e.addAction("Open the settings"),e.addCancelAction("Close"),[4,e.presentSheet()];case 4:switch(t=n.sent(),t){case 0:return[3,5];case 1:return[3,7]}return[3,10];case 5:return[4,b()];case 6:return n.sent().presentMedium(),[3,11];case 7:return[4,m()];case 8:return n.sent(),[4,g()];case 9:return n.sent(),[3,11];case 10:return[3,11];case 11:return[2]}}))}))}function m(){return t(this,void 0,void 0,(function(){var t,r;return n(this,(function(n){switch(n.label){case 0:return[4,(t=new WebView).loadHTML('\n<!DOCTYPE html>\n<html lang="en">\n\n<head>\n  <meta charset="UTF-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">\n</head>\n\n<body>\n  <main class="container">\n    <h1>'.concat(Script.name(),'</h1>\n    <label for="notionSecret">Notion Integration Secret</label>\n    <input type="text" id="notionSecret" name="notionSecret" placeholder="secret_XXXXXXX" value="').concat(f.notionSecret,'" required>\n    \n    <label for="databaseId">Database ID</label>\n    <input type="text" id="databaseId" name="databaseId" placeholder="XXXXXXXXXX" value="').concat(f.databaseId,'" required>\n\n    <label for="sorts">Sorts</label>\n    <textarea id="sorts" name="sorts" placeholder="[]" required>').concat(JSON.stringify(f.sorts,null,2),'</textarea>\n\n    <label for="filter">Filter</label>\n    <textarea id="filter" name="filter" placeholder="{}" required>').concat(JSON.stringify(f.filter,null,2),'</textarea>\n  </main>\n\n  <script>\n    const parseJson = (val, fallback) => { try { return JSON.parse(val); } catch { return fallback; } };\n\n    window.getSettings = () => ({\n      ...Object.fromEntries(Array.from(document.querySelectorAll(\'input[name], textarea[name], select[name]\')).map(input => [input.name, input.value])),\n      sorts: parseJson(document.querySelector("[name=sorts]").value, []),\n      filter: parseJson(document.querySelector("[name=filter]").value, []),\n    })\n  <\/script>\n</body>\n</html>\n'))];case 1:return n.sent(),[4,t.present()];case 2:return n.sent(),[4,t.evaluateJavaScript("window.getSettings()")];case 3:return r=n.sent(),f=e(e({},f),r),console.log(f),[4,y()];case 4:return n.sent(),[2]}}))}))}function y(){return t(this,void 0,void 0,(function(){var e,t,r;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,10]),[4,v()];case 1:return n.sent(),Keychain.set(p,JSON.stringify(f)),[3,10];case 2:return e=n.sent(),(t=new Alert).title="Failed to fetch data from notion",t.message="It seems that the settings provided are not valid.\nNotion answered with an error:\n".concat(e.message),t.addAction("Edit settings"),t.addCancelAction("Keep previous settings"),t.addDestructiveAction("Save anyway"),[4,t.presentSheet()];case 3:switch(r=n.sent(),r){case-1:return[3,4];case 0:return[3,5];case 1:return[3,7]}return[3,8];case 4:return f=h(),[2];case 5:return[4,m()];case 6:return n.sent(),[3,9];case 7:return Keychain.set(p,JSON.stringify(f)),[3,9];case 8:return[3,9];case 9:case 10:return[2]}}))}))}function v(){return t(this,void 0,void 0,(function(){var e,t,r;return n(this,(function(n){switch(n.label){case 0:return[4,(e=new c(f.notionSecret)).getDatabase(f.databaseId)];case 1:return t=n.sent(),[4,e.queryDatabase(f.databaseId,{filter:f.filter,sorts:f.sorts})];case 2:if(r=n.sent(),"error"===t.object||"error"===r.object)throw console.warn(t.message||r.message),new Error(t.message||r.message);return[2,{database:t,query:r}]}}))}))}function b(){return t(this,void 0,void 0,(function(){var e,t,c,l,p,h,g,m,y;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,v()];case 1:return e=n.sent(),t=e.database,c=e.query,l=c.results.map((function(e){var t,n;return{url:"notion://www.notion.so/".concat(f.databaseId),name:e.properties.Name.title[0].plain_text,date:null===(n=null===(t=e.properties.Deadline)||void 0===t?void 0:t.date)||void 0===n?void 0:n.start}})),p="notion://www.notion.so/".concat(f.databaseId),h=Color.dynamic(Color.black(),Color.white()),g={header:{stack:{url:p},image:{imageSize:new Size(20,20),tintColor:h},text:{textColor:h,font:Font.boldSystemFont(15)},btnRefresh:{url:"shortcuts://run-shortcut?name=Refresh%20All%20Widgets",imageSize:new Size(20,20),tintColor:h},btnSettings:{url:URLScheme.forRunningScript()+"?settings=true",imageSize:new Size(20,20),tintColor:h}},task:{stack:{url:p},image:{imageSize:new Size(15,15),tintColor:h,imageOpacity:.75,url:p},text:{textColor:h,font:Font.mediumSystemFont(15)},date:{textColor:h,font:Font.regularSystemFont(15),textOpacity:.75}}},m=Math.min(l.length,4),[4,u(o||(o=r(['\n<widget>\n  <spacer value="16" />\n  <hstack styles="','">\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <text styles="','">','</text>\n    <spacer />\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <image styles="','" src="','" />\n  </hstack>\n  <spacer value="10" />\n  <vstack>\n    ',"\n    ","\n    <spacer />\n  </vstack>\n</widget>\n"],['\n<widget>\n  <spacer value="16" />\n  <hstack styles="','">\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <text styles="','">','</text>\n    <spacer />\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <image styles="','" src="','" />\n  </hstack>\n  <spacer value="10" />\n  <vstack>\n    ',"\n    ","\n    <spacer />\n  </vstack>\n</widget>\n"])),g.header.stack,g.header.image,SFSymbol.named("checklist").image,g.header.text,t.title[0].plain_text,g.header.btnSettings,SFSymbol.named("gear").image,g.header.btnRefresh,SFSymbol.named("arrow.clockwise.circle").image,l.slice(0,m).map((function(e){return d(s||(s=r(['\n        <hstack styles="','">\n         <image styles="','" src="','" />\n         <spacer value="6" />\n         <text styles="','">',"</text>\n         ",'\n        </hstack>\n        <spacer value="8" />\n      '],['\n        <hstack styles="','">\n         <image styles="','" src="','" />\n         <spacer value="6" />\n         <text styles="','">',"</text>\n         ",'\n        </hstack>\n        <spacer value="8" />\n      '])),g.task.stack,g.task.image,SFSymbol.named("circle").image,g.task.text,e.name,e.date?d(a||(a=r(['\n            <text styles="','"> — ',"</text>\n          "],['\n            <text styles="','"> — ',"</text>\n          "])),g.task.date,(new RelativeDateTimeFormatter).string(new Date(e.date),new Date)):"")})),l.length>m?d(i||(i=r(['\n    <hstack>\n      <image styles="','" src="','" />\n      <spacer value="6" />\n      <text styles="','">',' more</text>\n    </hstack>\n    <spacer value="8" />\n    '],['\n    <hstack>\n      <image styles="','" src="','" />\n      <spacer value="6" />\n      <text styles="','">',' more</text>\n    </hstack>\n    <spacer value="8" />\n    '])),g.task.image,SFSymbol.named("plus.circle").image,g.task.text,(l.length-m).toString()):"")];case 2:return[2,n.sent()];case 3:throw y=n.sent(),console.warn("[buildWidget]"),console.error(y),y;case 4:return[2]}}))}))}t(void 0,void 0,void 0,(function(){var e;return n(this,(function(t){switch(t.label){case 0:return!config.runsInApp||args.notification?[3,2]:[4,g()];case 1:t.sent(),t.label=2;case 2:return[4,b()];case 3:return e=t.sent(),Script.setWidget(e),[2]}}))}));

// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: cyan; icon-glyph: tasks;
// Build at 2023-01-27T01:31:59
"use strict";var e=function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},e.apply(this,arguments)};function t(e,t,n,r){return new(n||(n=Promise))((function(a,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function i(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,i)}c((r=r.apply(e,t||[])).next())}))}function n(e,t){var n,r,a,o,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){s.label=i[1];break}if(6===i[0]&&s.label<a[1]){s.label=a[1],a=i;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(i);break}a[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function r(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var a=function(){function e(e){this.base="https://api.notion.com/v1",this.secret=e}return e.prototype.request=function(e,t,n){this.base.endsWith("/")||(this.base+="/"),t.startsWith("/")&&(t=t.slice(1));var r=new Request(t.includes("://")?t:"".concat(this.base).concat(t));return r.method=e.toUpperCase(),r.body=n?JSON.stringify(n):null,r.url.startsWith(this.base)&&(r.headers={Authorization:"Bearer ".concat(this.secret),"Notion-Version":"2022-06-28","Content-Type":"application/json"}),r},e.prototype.get=function(e){return this.request("GET",e).loadJSON()},e.prototype.post=function(e,t){return this.request("POST",e,t).loadJSON()},e.prototype.queryDatabase=function(e,t){return this.post("databases/".concat(e,"/query"),t)},e.prototype.getDatabase=function(e){return this.get("databases/".concat(e))},e.prototype.getPage=function(e){return this.get("pages/".concat(e))},e.prototype.getImage=function(e){return this.request("GET",e).loadImage()},e}(),o=function(){function e(e){if(e&&e.constructor&&e.constructor.toString){var t=e.constructor.toString().match(/function\s*(\w+)/);if(t&&2==t.length)return t[1]}}function r(t,n){return Object.keys(n).forEach((function(r){if(-1!==r.indexOf("*")){if(!((r=r.replace("*",""))in t))throw new Error('Method "'.concat(r,'()" is not applicable to instance of ').concat(e(t)));Array.isArray(n["*"+r])?t[r].apply(t,n["*"+r]):t[r](n[r])}else{if(!(r in t))throw new Error('Property "'.concat(r,'" is not applicable to instance of ').concat(e(t)));t[r]=n[r]}})),t}function a(e,t){return t.forEach((function(t){if("text"===t.tag){var n=/(\$\$\[.+\])/gi;n.test(t.textContent)&&(t.textContent=t.textContent.replace(n,(function(e,t){return s[t].toString()})));var i=e.addText(t.textContent.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&"));r(i,o(t.attributes,"styles")),r(i,o(t.attributes,"attr"))}else if("spacer"===t.tag){var c=parseInt(o(t.attributes,"value"),10);c<1||isNaN(c)?e.addSpacer():e.addSpacer(c)}else if("image"===t.tag){var l=e.addImage(o(t.attributes,"src"));r(l,o(t.attributes,"styles")),r(l,o(t.attributes,"attr"))}else if("date"===t.tag){var u=e.addDate(o(t.attributes,"value"));r(u,o(t.attributes,"styles")),r(u,o(t.attributes,"attr"))}else if("stack"===t.tag){r(d=e.addStack(),o(t.attributes,"styles")),r(d,o(t.attributes,"attr")),a(d,t.children)}else if(-1!==["hstack","vstack"].indexOf(t.tag)){var d;(d=e.addStack())["hstack"===t.tag?"layoutHorizontally":"layoutVertically"](),r(d,o(t.attributes,"styles")),r(d,o(t.attributes,"attr")),a(d,t.children)}})),e}function o(e,t){void 0===e&&(e=[]),void 0===t&&(t="styles");var n={};return e.forEach((function(e){e.name.toLowerCase()===t.toLowerCase()&&(n=void 0!==s[e.value]?s[e.value]:e.value)})),n}var s={};function i(e,t){var n="";return e.forEach((function(e,r){if(t[r])if(Array.isArray(t[r])&&(t[r]=t[r].join("")),"string"==typeof t[r])n+=e+t[r];else{var a="$$["+UUID.string()+Math.floor(20*Math.random())+"]";s[a]=t[r],n+=e+a}else n+=e})),n}function c(e){return t(this,void 0,void 0,(function(){var t,r,a,o;return n(this,(function(n){switch(n.label){case 0:return[4,(t=new WebView).loadHTML("<html></html>")];case 1:return n.sent(),e=function(e){return(e=e.replace(/(\r\n|\n|\r)/gm,"")).replace(/<\s*text[^>]*>(.*?)<\s*\/\s*text>/gi,(function(e,t){return e.replace(t,t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"))}))}(e),e="<tabom>".concat(e,"</tabom>"),r="\n        var getAttributes = function (attributes) {\n            return Array.prototype.map.call(attributes, function (attribute) {\n                return {\n                    name: attribute.name,\n                    value: attribute.value\n                };\n            });\n        };\n        \n        var createDOMMap = function (element) {\n            return Array.prototype.map.call(element.childNodes, (function (node) {\n                if (node.nodeType !== 3 && node.nodeType !== 8) {\n                    var details = {\n                        tag: node.tagName.toLowerCase(),\n                        textContent: node.textContent,\n                        attributes: node.nodeType !== 1 ? [] : getAttributes(node.attributes)\n                    };\n                    details.children = createDOMMap(node);\n                    return details;\n                }\n                return null;\n            })).filter((e) => e !== null);\n        };\n        \n        function getDom() {\n            let htmlStr = '".concat(e,"';\n            const dom = new DOMParser();\n            let doc = dom.parseFromString(htmlStr, 'application/xml');\n            return JSON.stringify(createDOMMap(doc.documentElement));\n        }\n        try {\n            completion(getDom());\n        }\n        catch (err) {\n            completion([{\n                tag: 'error',\n                textContent: err.message\n            }]);\n        }    \n      "),[4,t.evaluateJavaScript(r,!0)];case 2:if(a=n.sent(),(o=JSON.parse(a)).length&&-1!==o[0].tag.toLocaleLowerCase().indexOf("error"))throw new Error(o[0].textContent);return[2,o]}}))}))}return{widgetMarkup:function(e){for(var s=[],l=1;l<arguments.length;l++)s[l-1]=arguments[l];return t(this,void 0,void 0,(function(){var t,l,u,d;return n(this,(function(n){switch(n.label){case 0:return[4,c(i(e,s))];case 1:if(t=n.sent(),void 0===(l=t[0]))throw new Error("WidgetMarkup requires that the <widget> element be the parent element of your widget.");return u=l.children,r(d=new ListWidget,o(l.attributes,"styles")),r(d,o(l.attributes,"attr")),a(d,u),[2,d]}}))}))},concatMarkup:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=i(e,t);return r}}}(),s=o.widgetMarkup,i=o.concatMarkup,c=!1,l=module.filename.includes("Documents/iCloud~"),u=module.filename.includes("Documents/iCloud~")?FileManager.iCloud():FileManager.local(),d=u.joinPath(u.documentsDirectory(),"cache/nobg"),h="".concat(Device.model(),"_").concat(Device.name()).replace(/[^a-zA-Z0-9\-\_]/,"").toLowerCase(),m=function(e){var r=e.caller,a=void 0===r?"none":r;return t(this,void 0,void 0,(function(){var e,t,r,o,s,i,m,g,p,k,x,C;return n(this,(function(O){switch(O.label){case 0:return e={caller:a},[4,S()];case 1:return t=O.sent()?"dark":"light",r="dark"==t?"light":"dark",u.fileExists(d)||u.createDirectory(d,!0),[4,w("To change background make sure you have a screenshot of you home screen. Go to your home screen and enter wiggle mode. Scroll to the empty page on the far right and take a screenshot.",["Pick Screenshot","Exit to Take Screenshot"],c)];case 2:return 1==(o=O.sent())?[2,!1]:[4,Photos.fromLibrary()];case 3:return s=O.sent(),i=s.size.height,m="",2436!=i?[3,8]:[4,f()];case 4:return void 0!==(g=O.sent())["phone-model"]?[3,7]:[4,w("What model of iPhone do you have?",["iPhone 12 mini","iPhone 11 Pro, XS, or X"],c)];case 5:return o=O.sent(),g["phone-model"]=o,[4,b(g)];case 6:return O.sent(),0===o&&(m="_mini"),[3,8];case 7:g["phone-model"]&&(m="_mini"),O.label=8;case 8:return(p=y[i+m])?[3,10]:[4,w("It looks like you selected an image that isn't an iPhone screenshot, or your iPhone is not supported. Try again with a different image.",["OK"],c)];case 9:return O.sent(),[2,!1];case 10:k=["small","medium","large"],x=function(){var e,r,a,o,i,c,m;return n(this,(function(n){switch(n.label){case 0:e=k[C],r=v[e].map((function(t){var n=t.toLowerCase().replace(" ","-"),r={pos:n,w:"",h:"",x:"",y:""};r.w=p[e].w,r.h=p[e].h,r.x=p.left;var a=n.split("-");return r.y=p[a[0]],"large"==e&&"bottom"==a[0]&&(r.y=p.middle),a.length>1&&(r.x=p[a[1]]),r})),a=0,n.label=1;case 1:return a<r.length?(o=r[a],g=s,f=new Rect(o.x,o.y,o.w,o.h),(b=new DrawContext).size=new Size(f.width,f.height),b.drawImageAtPoint(g,new Point(-f.x,-f.y)),i=b.getImage(),c="".concat(h,"-").concat(t,"-").concat(e,"-").concat(o.pos,".jpg"),m=u.joinPath(d,c),u.fileExists(m)?l?[4,u.downloadFileFromiCloud(m)]:[3,3]:[3,4]):[3,6];case 2:n.sent(),n.label=3;case 3:try{u.remove(m)}catch(e){}n.label=4;case 4:u.writeImage(m,i),n.label=5;case 5:return a++,[3,1];case 6:return[2]}var g,f,b}))},C=0,O.label=11;case 11:return C<k.length?[5,x()]:[3,14];case 12:O.sent(),O.label=13;case 13:return C++,[3,11];case 14:return[4,w("self"!=e.caller?"Slices saved for ".concat(t," mode. You can switch to ").concat(r," mode and run this again to also generate slices."):"Slices saved.",["Ok"],c)];case 15:return O.sent(),[2,!0]}}))}))},g=function(e,r){return void 0===r&&(r=!1),t(this,void 0,void 0,(function(){var t,a,o,s,i,c,g;return n(this,(function(n){switch(n.label){case 0:return[4,S()];case 1:return t=n.sent()?"dark":"light",[4,f()];case 2:return a=n.sent(),(o=r?null:a[e])?[3,10]:(log('Background for "'.concat(e,'" is not yet set.')),s=u.joinPath(d,"".concat(h,"-").concat(t,"-medium-top.jpg")),i=!1,u.fileExists(s)?[3,4]:[4,m({caller:"self"})]);case 3:return i=n.sent(),[3,5];case 4:i=!0,n.label=5;case 5:return i?[4,p(e)]:[3,7];case 6:c=n.sent(),n.label=7;case 7:return c?[4,f()]:[3,9];case 8:return a=n.sent(),o=a[e],[3,10];case 9:return[2,null];case 10:return g=u.joinPath(d,"".concat(h,"-").concat(t,"-").concat(o,".jpg")),u.fileExists(g)?l?[4,u.downloadFileFromiCloud(g)]:[3,12]:(log("Slice does not exists - ".concat(h,"-").concat(t,"-").concat(o,".jpg")),[2,null]);case 11:n.sent(),n.label=12;case 12:return[2,u.readImage(g)]}}))}))},p=function(e){return t(this,void 0,void 0,(function(){var t,r,a,o,s,i,l,u;return n(this,(function(n){switch(n.label){case 0:return[4,w(t="What is the size of the widget?",r=["Small","Medium","Large","Cancel"],c)];case 1:return 3==(a=n.sent())?[2,!1]:(o=r[a].toLowerCase(),t="Where will it be placed on?",(s=v[o]).push("Cancel"),[4,w(t,s,c)]);case 2:return(i=n.sent())==s.length-1?[2,!1]:(l=s[i].toLowerCase().replace(" ","-"),[4,f()]);case 3:return(u=n.sent())[e]="".concat(o,"-").concat(l),[4,b(u)];case 4:return n.sent(),[4,w("Background saved.",["Ok"],c)];case 5:return n.sent(),[2,!0]}}))}))};function f(){return t(this,void 0,void 0,(function(){var e,t;return n(this,(function(n){switch(n.label){case 0:return e=u.joinPath(d,"widget-positions.json"),u.fileExists(e)?[3,2]:[4,u.writeString(e,"{}")];case 1:return n.sent(),[2,{}];case 2:return l?[4,u.downloadFileFromiCloud(e)]:[3,4];case 3:n.sent(),n.label=4;case 4:return t=u.readString(e),[2,JSON.parse(t)]}}))}))}function b(e){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return t=u.joinPath(d,"widget-positions.json"),l?[4,u.downloadFileFromiCloud(t)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[4,u.writeString(t,JSON.stringify(e))];case 3:return n.sent(),[2,e]}}))}))}function w(e,r,a){return void 0===e&&(e=""),void 0===r&&(r=["OK"]),void 0===a&&(a=!1),t(this,void 0,void 0,(function(){var t,o,s;return n(this,(function(n){switch(n.label){case 0:for((t=new Alert).message=e,o=0;o<r.length;o++)t.addAction(r[o]);return a?[4,t.presentSheet()]:[3,2];case 1:return s=n.sent(),[3,4];case 2:return[4,t.presentAlert()];case 3:s=n.sent(),n.label=4;case 4:return[2,s]}}))}))}var v={small:["Top Left","Top Right","Middle Left","Middle Right","Bottom Left","Bottom Right"],medium:["Top","Middle","Bottom"],large:["Top","Bottom"]},y={2796:{models:["14 Pro Max"],small:{w:510,h:510},medium:{w:1092,h:510},large:{w:1092,h:1146},left:99,right:681,top:282,middle:918,bottom:1554},2556:{models:["14 Pro"],small:{w:474,h:474},medium:{w:1014,h:474},large:{w:1014,h:1062},left:82,right:622,top:270,middle:858,bottom:1446},2778:{models:["12 Pro Max","13 Pro Max","14 Plus"],small:{w:510,h:510},medium:{w:1092,h:510},large:{w:1092,h:1146},left:96,right:678,top:246,middle:882,bottom:1518},2532:{models:["12","12 Pro","13","14"],small:{w:474,h:474},medium:{w:1014,h:474},large:{w:1014,h:1062},left:78,right:618,top:231,middle:819,bottom:1407},2688:{models:["Xs Max","11 Pro Max"],small:{w:507,h:507},medium:{w:1080,h:507},large:{w:1080,h:1137},left:81,right:654,top:228,middle:858,bottom:1488},1792:{models:["11","Xr"],small:{w:338,h:338},medium:{w:720,h:338},large:{w:720,h:758},left:54,right:436,top:160,middle:580,bottom:1e3},2436:{models:["X","Xs","11 Pro"],small:{w:465,h:465},medium:{w:987,h:465},large:{w:987,h:1035},left:69,right:591,top:213,middle:783,bottom:1353},"2436_mini":{models:["12 Mini"],small:{w:465,h:465},medium:{w:987,h:465},large:{w:987,h:1035},left:69,right:591,top:231,middle:801,bottom:1371},2208:{models:["6+","6s+","7+","8+"],small:{w:471,h:471},medium:{w:1044,h:471},large:{w:1044,h:1071},left:99,right:672,top:114,middle:696,bottom:1278},1334:{models:["6","6s","7","8"],small:{w:296,h:296},medium:{w:642,h:296},large:{w:642,h:648},left:54,right:400,top:60,middle:412,bottom:764},1136:{models:["5","5s","5c","SE"],small:{w:282,h:282},medium:{w:584,h:282},large:{w:584,h:622},left:30,right:332,top:59,middle:399,bottom:399}};function S(){return t(this,void 0,void 0,(function(){return n(this,(function(e){return[2,!Color.dynamic(Color.white(),Color.black()).red]}))}))}var k,x,C,O,I,P="fr.zaosoula.notionwidget",M=function(){return Keychain.contains(P)?e(e({},{notionSecret:"",databaseId:"",sorts:[],filter:{},color:"auto",useBackgroundImage:!1}),JSON.parse(Keychain.get(P))):{notionSecret:"",databaseId:"",sorts:[],filter:{},color:"auto",useBackgroundImage:!1}},A=M();function D(){return t(this,void 0,void 0,(function(){var e,t,r,a;return n(this,(function(n){switch(n.label){case 0:return[4,F()];case 1:return n.sent(),e=new Alert,args.queryParameters.settings?[4,q()]:[3,3];case 2:n.sent(),n.label=3;case 3:return e.title=Script.name(),e.addAction("Preview the widget"),e.addAction("Open the settings"),e.addAction("Generate widget background"),e.addCancelAction("Close"),[4,e.presentSheet()];case 4:switch(t=n.sent(),t){case 0:return[3,5];case 1:return[3,7];case 2:return[3,10]}return[3,13];case 5:return[4,E()];case 6:return n.sent().presentMedium(),[3,14];case 7:return[4,q()];case 8:return n.sent(),[4,D()];case 9:return n.sent(),[3,14];case 10:return[4,m({caller:"self"})];case 11:return n.sent(),a=(r=console).log,[4,g(Script.name(),!0)];case 12:return a.apply(r,[n.sent()]),[3,14];case 13:return[3,14];case 14:return[2]}}))}))}function q(){return t(this,void 0,void 0,(function(){var t,a,o;return n(this,(function(n){switch(n.label){case 0:return t=function(e,t,n){return i(k||(k=r(['<option value="','" ',">","</option>"],['<option value="','" ',">","</option>"])),e,e==n?"selected":"",t)},(a=new WebView).shouldAllowRequest=function(e){return!e.url.startsWith("http")||(Safari.open(e.url),!1)},[4,a.loadHTML('\n<!DOCTYPE html>\n<html lang="en">\n\n<head>\n  <meta charset="UTF-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">\n</head>\n\n<body>\n  <nav class="container-fluid">\n      <ul>\n        <li><strong>'.concat(Script.name(),'</strong></li>\n      </ul>\n      <ul>\n      <li><a href="https://github.com/zaosoula/scriptable">Docs</a></li>\n      </ul>\n    </nav>\n    <hr />\n  <main class="container">\n    <details>\n      <summary>Notion settings</summary>\n      \n      <label for="notionSecret">Notion Integration Secret</label>\n      <input type="text" id="notionSecret" name="notionSecret" placeholder="secret_XXXXXXX" value="').concat(A.notionSecret,'" required>\n      <small><a href="https://developers.notion.com/docs/create-a-notion-integration#step-1-create-an-integration">Create an integration</a></small>\n      \n      <label for="databaseId">Database ID</label>\n      <input type="text" id="databaseId" name="databaseId" placeholder="XXXXXXXXXX" value="').concat(A.databaseId,'" required>\n      <small><a href="https://developers.notion.com/docs/create-a-notion-integration#step-2-share-a-database-with-your-integration">Share a database with your integration</a></small>\n\n      <label for="sorts">Sorts</label>\n      <textarea id="sorts" name="sorts" placeholder="[]" required>').concat(JSON.stringify(A.sorts,null,2),'</textarea>\n      <small><a href="https://developers.notion.com/reference/post-database-query-sort">Sort object</a></small>\n\n      <label for="filter">Filter</label>\n      <textarea id="filter" name="filter" placeholder="{}" required>').concat(JSON.stringify(A.filter,null,2),'</textarea>\n      <small><a href="https://developers.notion.com/reference/post-database-query-filter">Filter object</a></small>\n\n    </details>\n\n    <details>\n      <summary>Appearance</summary>\n      \n      <fieldset>\n        <label for="useBackgroundImage">\n          <input type="checkbox" id="useBackgroundImage" name="useBackgroundImage" role="switch" ').concat(A.useBackgroundImage?"checked":"",'/>\n          Use background image \n        </label>\n        <small>\n          You can generate the background image from the main menu\n        </small>\n      </fieldset>\n\n      <label for="color">Text color</label>\n      <select id="color" name="color" required>\n        ').concat(t("auto","System",A.color),"\n        ").concat(t("black","Dark",A.color),"\n        ").concat(t("white","Light",A.color),'\n      </select>\n    </details>\n  </main>\n\n  <script>\n    const parseJson = (val, fallback) => { try { return JSON.parse(val); } catch { return fallback; } };\n\n    window.getSettings = () => ({\n      ...Object.fromEntries(Array.from(document.querySelectorAll(\'input[name], textarea[name], select[name]\')).map(input => [input.name, input.value])),\n      useBackgroundImage: document.querySelector("[name=useBackgroundImage]").checked,\n      sorts: parseJson(document.querySelector("[name=sorts]").value, []),\n      filter: parseJson(document.querySelector("[name=filter]").value, []),\n    })\n  <\/script>\n</body>\n</html>\n'))];case 1:return n.sent(),[4,a.present()];case 2:return n.sent(),[4,a.evaluateJavaScript("window.getSettings()")];case 3:return o=n.sent(),A=e(e({},A),o),console.log(A),[4,F()];case 4:return n.sent(),[2]}}))}))}function F(){return t(this,void 0,void 0,(function(){var e,t,r;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,10]),[4,j()];case 1:return n.sent(),Keychain.set(P,JSON.stringify(A)),[3,10];case 2:return e=n.sent(),(t=new Alert).title="Failed to fetch data from notion",t.message="It seems that the settings provided are not valid.\nNotion answered with an error:\n".concat(e.message),t.addAction("Edit settings"),t.addCancelAction("Keep previous settings"),t.addDestructiveAction("Save anyway"),[4,t.presentSheet()];case 3:switch(r=n.sent(),r){case-1:return[3,4];case 0:return[3,5];case 1:return[3,7]}return[3,8];case 4:return A=M(),[2];case 5:return[4,q()];case 6:return n.sent(),[3,9];case 7:return Keychain.set(P,JSON.stringify(A)),[3,9];case 8:return[3,9];case 9:case 10:return[2]}}))}))}function j(){return t(this,void 0,void 0,(function(){var e,t,r;return n(this,(function(n){switch(n.label){case 0:return[4,(e=new a(A.notionSecret)).getDatabase(A.databaseId)];case 1:return t=n.sent(),[4,e.queryDatabase(A.databaseId,{filter:A.filter,sorts:A.sorts})];case 2:if(r=n.sent(),"error"===t.object||"error"===r.object)throw console.warn(t.message||r.message),new Error(t.message||r.message);return[2,{database:t,query:r}]}}))}))}function E(){return t(this,void 0,void 0,(function(){var e,t,a,o,c,l,u,d,h,m;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,5,,6]),[4,j()];case 1:return e=n.sent(),t=e.database,a=e.query,o=a.results.map((function(e){var t,n;return{url:"notion://www.notion.so/".concat(A.databaseId),name:e.properties.Name.title[0].plain_text,date:null===(n=null===(t=e.properties.Deadline)||void 0===t?void 0:t.date)||void 0===n?void 0:n.start}})),c="notion://www.notion.so/".concat(A.databaseId),l=Color.dynamic(Color.black(),Color.white()),"auto"!==A.color&&(l=Color[A.color]()),u=null,A.useBackgroundImage?[4,g(Script.name())]:[3,3];case 2:u=n.sent(),n.label=3;case 3:return d={widget:{backgroundImage:u},header:{stack:{url:c},image:{imageSize:new Size(20,20),tintColor:l},text:{textColor:l,font:Font.boldSystemFont(15)},btnRefresh:{url:"shortcuts://run-shortcut?name=Refresh%20All%20Widgets",imageSize:new Size(20,20),tintColor:l},btnSettings:{url:URLScheme.forRunningScript()+"?settings=true",imageSize:new Size(20,20),tintColor:l}},task:{stack:{url:c},image:{imageSize:new Size(15,15),tintColor:l,imageOpacity:.75,url:c},text:{textColor:l,font:Font.mediumSystemFont(15)},date:{textColor:l,font:Font.regularSystemFont(15),textOpacity:.75}}},h=Math.min(o.length,4),[4,s(I||(I=r(['\n<widget styles="','">\n  <spacer value="16" />\n  <hstack styles="','">\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <text styles="','">','</text>\n    <spacer />\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <image styles="','" src="','" />\n  </hstack>\n  <spacer value="10" />\n  <vstack>\n    ',"\n    ","\n    <spacer />\n  </vstack>\n</widget>\n"],['\n<widget styles="','">\n  <spacer value="16" />\n  <hstack styles="','">\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <text styles="','">','</text>\n    <spacer />\n    <image styles="','" src="','" />\n    <spacer value="6" />\n    <image styles="','" src="','" />\n  </hstack>\n  <spacer value="10" />\n  <vstack>\n    ',"\n    ","\n    <spacer />\n  </vstack>\n</widget>\n"])),d.widget,d.header.stack,d.header.image,SFSymbol.named("checklist").image,d.header.text,t.title[0].plain_text,d.header.btnSettings,SFSymbol.named("gear").image,d.header.btnRefresh,SFSymbol.named("arrow.clockwise.circle").image,o.slice(0,h).map((function(e){return i(C||(C=r(['\n        <hstack styles="','">\n         <image styles="','" src="','" />\n         <spacer value="6" />\n         <text styles="','">',"</text>\n         ",'\n        </hstack>\n        <spacer value="8" />\n      '],['\n        <hstack styles="','">\n         <image styles="','" src="','" />\n         <spacer value="6" />\n         <text styles="','">',"</text>\n         ",'\n        </hstack>\n        <spacer value="8" />\n      '])),d.task.stack,d.task.image,SFSymbol.named("circle").image,d.task.text,e.name,e.date?i(x||(x=r(['\n            <text styles="','"> — ',"</text>\n          "],['\n            <text styles="','"> — ',"</text>\n          "])),d.task.date,(new RelativeDateTimeFormatter).string(new Date(e.date),new Date)):"")})),o.length>h?i(O||(O=r(['\n    <hstack>\n      <image styles="','" src="','" />\n      <spacer value="6" />\n      <text styles="','">',' more</text>\n    </hstack>\n    <spacer value="8" />\n    '],['\n    <hstack>\n      <image styles="','" src="','" />\n      <spacer value="6" />\n      <text styles="','">',' more</text>\n    </hstack>\n    <spacer value="8" />\n    '])),d.task.image,SFSymbol.named("plus.circle").image,d.task.text,(o.length-h).toString()):"")];case 4:return[2,n.sent()];case 5:throw m=n.sent(),console.warn("[buildWidget]"),console.error(m),m;case 6:return[2]}}))}))}t(void 0,void 0,void 0,(function(){var e;return n(this,(function(t){switch(t.label){case 0:return!config.runsInApp||args.notification?[3,2]:[4,D()];case 1:t.sent(),t.label=2;case 2:return[4,E()];case 3:return e=t.sent(),Script.setWidget(e),[2]}}))}));
